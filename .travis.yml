language:
  - node_js

node_js:
  - 6

cache:
  directories:
    - $HOME/.npm
    - node_modules

branches:
  except:
    - /^v\d+\.\d+\.\d+$/

notifications:
  slack: smartcar:PGJmjtKFPytU5E2FwsImdVp8

install:
  - git clone git@github.com:smartcar/build.git $HOME/smartcar-build
  - cp $HOME/smartcar-build/resources/Makefile .

  # --save false flag needed b/c of https://github.com/npm/npm/issues/16901
  - npm update --save false
  - npm prune

script:
  - npm test
  - npm run cover
  - make create-tag
  - gulp compress

deploy:
  - provider: script
    skip_cleanup: true
    script: gulp publish
    on:
      branch: master
  - provider: script
    skip_cleanup: true
    script: make push-tag
    on:
      branch: master
